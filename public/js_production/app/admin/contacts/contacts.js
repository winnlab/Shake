define(["canjs","underscore","app/contacts/contact","app/contacts/contactsModel","core/appState","css!app/contacts/css/contacts"],function(e,t,n,r,i){var s=e.Map.extend({define:{viewState:{value:"list"}},reOrder:function(e,t){t=t||"position";var n=this.attr(e);n.sort(function(e,n){return e[t]>n[t]?1:e[t]<n[t]?-1:0})},toList:function(){e.route.attr({module:"contacts",action:undefined,entity_id:undefined}),this.attr("viewState","list")},toEntity:function(t){e.route.attr({entity_id:t,action:"set",module:"contacts"})}});return e.Control.extend({defaults:{viewpath:"app/contacts/views/",contactsModel:r}},{init:function(){var t=this,n=e.route.attr();viewModel=new s,viewModel.attr({contacts:new r.List({})}),n.entity_id&&n.action&&(viewModel.attr("viewState","edit"),e.when(viewModel.attr("contacts")).then(function(){t.setContact(n.entity_id,n.action)})),t.element.html(e.view(t.options.viewpath+"index.stache",viewModel)),this.viewModel=viewModel},":module/:id route":function(e){var t=this.viewModel,n=t.attr("viewState");e.module==="contacts"&&n!=="list"&&t.toList()},":module/:action/:entity_id route":function(e){e.module==="contacts"&&this.setContact(e.entity_id,e.action)},".addContact click":function(e){this.viewModel.toEntity("0")},".editContact click":function(e){var t=e.parents(".contact").data("contact");this.viewModel.toEntity(t.attr("_id"))},setContact:function(e){this.viewModel.attr({id:Date.now(),viewState:"edit"});var i=this,s=i.element.find(".setContactWrap"),o=t.find(i.viewModel.attr("contacts"),function(t){return t&&t.attr("_id")===e});new n(s,{contact:o?o:new r})},".removeContact click":function(e){var t=e.parents(".contact").data("contact");confirm("Вы действительно хотите удалить контакт?")&&t.destroy().always(function(e,t,n){i.attr("notification",{status:t,msg:n.responseJSON.message})})},"{contactsModel} updated":function(){this.viewModel.reOrder("contacts")},"{contactsModel} created":function(e,t,n){var r=this,i=r.viewModel.attr("contacts");i.push(n),this.viewModel.reOrder("contacts")}})});