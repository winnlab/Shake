define(["canjs","core/appState","css!core/css/upload"],function(e,t){var n=e.Map.extend({url:"@","delete-url":"@",accept:"@",name:"@",multiple:"@",files:[],progress:0,define:{uploadId:{value:function(){var e="uploader-"+Math.ceil(Math.random()*1e3);return e}},uploaded:{set:function(t){var n=new e.List([]),r=this.attr("files");return r.replace([]),t&&(this.attr("multiple")?n.push(t):n.splice(0,1,t)),n}}},upload:function(e){var n=this,r=n.attr("files"),i=n.attr("name"),s=n.attr("entity"),o=s.attr("id")||s.attr("_id"),u;if(r.length&&o){u={data:{name:i,id:o},beforeSend:function(){n.attr("progress",0)},uploadProgress:function(e,t,r,i){n.attr("progress",i)},success:function(){n.attr("progress",100)}};var a=e.ajaxSubmit(u),f=a.data("jqxhr");f.done(function(e){s.uploaded&&s.uploaded(i,e.message[i]),t.attr("notification",{status:"success",msg:"Файл успешно выгружен"}),n.attr("progress",0)}).fail(function(e){t.attr("notification",{status:"error",msg:"Ошибка выгрузки файла"})})}else r.length&&t.attr("notification",{status:"error",msg:"Ошибка идентификации связи файла!"})},remove:function(n){var r=this,i=r.attr("uploaded"),s=r.attr("name"),o=r.attr("entity"),u=i.indexOf(n);e.ajax({url:r.attr("delete-url"),data:{name:s,sourceName:n,id:r.attr("entity.id")||r.attr("entity._id")},type:"DELETE"}).done(function(e){i.splice(u,1),o.removeUploaded&&o.removeUploaded(s),t.attr("notification",{status:"success",msg:"Файл успешно удален"})}).fail(function(e){t.attr("notification",{status:"error",msg:"Ошибка удаления файла"})})}});e.Component.extend({tag:"upload",scope:n,template:'<label class="btn btn-primary" for="{{uploadId}}"><content /></label>{{#if progress}}<div class="progress"><div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="{{progress}}" aria-valuemin="0" aria-valuemax="100" style="width: {{progress}}%;">{{progress}}%</div></div>{{/if}}<form action="{{url}}" method="POST" enctype="multipart/form-data"><input type="file" name="{{name}}{{#if multiple}}[]{{/if}}" accept="{{accept}}" id="{{uploadId}}" {{#if multiple}}multiple{{/if}}/></form>{{#if files.length}}<div class="queue">{{#each files}}<div>{{name}}</div>{{/each}}</div>{{/if}}{{#if uploaded.length}}<div class="uploadedWrap">{{#each uploaded}}{{{renderUploaded}}}{{#isDeleteBtn}}<div {{data "uploaded"}} class="remove btn btn-danger"><i class="fa fa-trash-o"></i></div>{{/isDeleteBtn}}{{/each}}</div>{{/if}}',events:{"input change":function(e,t){var n=this.scope,r=n.attr("files"),i=e[0].files;r.replace(i),n.upload(e.parents("form"))},".remove click":function(e,t){var n=e.data("uploaded");confirm("Вы действительно хотите удалить этот файл?")&&this.scope.remove(n)}},helpers:{isDeleteBtn:function(e){var t=this.attr("uploaded");return this.attr("delete-url")&&t.length?e.fn():e.inverse()},renderUploaded:function(e){var t=this.attr("accept")||"image",n=e.context,r;return t.indexOf("image")!==-1?r='<span class="uploaded thumbnail" style="background-image: url(\'/uploads/'+n+"')\"></span>":r="<span>"+n+"</span>&nbsp;",r}}})});