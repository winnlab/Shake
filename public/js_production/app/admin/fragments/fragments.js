define(["canjs","underscore","app/fragments/fragment","app/fragments/fragmentsModel","app/products/productsModel","app/days/daysModel","core/appState","css!app/fragments/css/fragments"],function(e,t,n,r,i,s,o){var u=e.Map.extend({define:{viewState:{value:"list"}},reOrder:function(e,t){t=t||"position";var n=this.attr(e);n.sort(function(e,n){return e[t]>n[t]?1:e[t]<n[t]?-1:0})},toList:function(){e.route.attr({module:"fragments",action:undefined,entity_id:undefined}),this.attr("viewState","list")},toEntity:function(t){e.route.attr({entity_id:t,action:"set",module:"fragments"})}});return e.Control.extend({defaults:{viewpath:"app/fragments/views/",FragmentsModel:r,ProductsModel:i,DaysModel:s}},{init:function(){var t=this,n=e.route.attr();viewModel=new u,viewModel.attr("product_id",e.route.attr("id")),viewModel.attr({days:new s.List({}),product:new i.List({_id:viewModel.attr("product_id")}),fragments:new r.List({product_id:viewModel.attr("product_id")})}),n.entity_id&&n.action&&(viewModel.attr("viewState","edit"),e.when(viewModel.attr("fragments"),viewModel.attr("days"),viewModel.attr("product")).then(function(){t.setFragment(n.entity_id,n.action)})),t.element.html(e.view(t.options.viewpath+"index.stache",viewModel)),this.viewModel=viewModel},":module/:id route":function(e){var t=this.viewModel,n=t.attr("viewState"),r=t.attr("product_id");e.module==="fragments"&&n!=="list"&&e.id===r&&t.toList(this.product_id)},":module/:id/:action/:entity_id route":function(e){e.module==="fragments"&&e.id===this.viewModel.attr("product_id")&&this.setFragment(e.entity_id,e.action)},".addFragment click":function(e){this.viewModel.toEntity("0")},".editFragment click":function(e){var t=e.parents(".fragment").data("fragment");this.viewModel.toEntity(t.attr("_id"))},setFragment:function(e){var i=this.viewModel.attr("product");if(!i.length)return;this.viewModel.attr({id:Date.now(),viewState:"edit"});var s=this,o=s.element.find(".setFragmentWrap"),u=t.find(s.viewModel.attr("fragments"),function(t){return t&&t.attr("_id")===e});new n(o,{fragment:u?u:new r,days:s.viewModel.attr("days")})},".removeFragment click":function(e){var t=e.parents(".fragment").data("fragment");confirm('Вы действительно хотите удалить фрагмент: "'+t.attr("name")+'"?')&&t.destroy().always(function(e,t,n){o.attr("notification",{status:t,msg:e.name+". "+n.responseJSON.message})})},"{FragmentsModel} updated":function(){this.viewModel.reOrder("fragments")},"{FragmentsModel} created":function(e,t,n){var r=this,i=r.viewModel.attr("fragments");i.push(n),this.viewModel.reOrder("fragments")},"{DaysModel} created":function(e,t,n){var r=this.viewModel.attr("days");r.push(n),this.viewModel.reOrder("days")},"{DaysModel} updated":function(){this.viewModel.reOrder("days")},"{ProductsModel} destroyed":function(e,t,n){var r=this.viewModel.attr("product"),i=this.viewModel.attr("fragments");r.indexOf(n)!==-1&&(this.viewModel.attr({viewState:"list",deletedProduct:n.attr("name")}),r.replace([]),i.replace([]))}})});