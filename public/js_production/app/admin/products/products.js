define(["canjs","underscore","app/products/product","app/products/productsModel","core/appState","css!app/products/css/products"],function(e,t,n,r,i){var s=e.Map.extend({define:{products:{value:new r.List({})},viewState:{value:"list",serialize:!1}},reOrderProducts:function(){var e=this.attr("products"),n=t.sortBy(e,function(e){return+e.position});e.replace(n)},toList:function(){e.route.attr({module:"products"},!0),this.attr("viewState","list")},toEntity:function(t){e.route.attr({entity_id:t,action:"set",module:"products"},!0)}});return e.Control.extend({defaults:{viewpath:"app/products/views/",ProductsModel:r}},{init:function(){var t=this,n=e.route.attr();t.viewModel=new s,n.entity_id&&n.action&&t.viewModel.attr("viewState","edit"),t.element.html(e.view(t.options.viewpath+"index.stache",this.viewModel,{langs:langs,getBg:function(e,t){e=e();var n=e&&e.attr("bottle")?'background-image: url("/uploads/'+e.attr("bottle")+'");':"";return n}}));var r=t.viewModel.attr("products");e.when(r).then(function(){n.entity_id&&n.action&&t.setProduct(n.entity_id,n.action)})},":module route":function(e){var t=this.viewModel;e.module==="products"&&t.attr("viewState")!=="list"&&t.toList()},":module/:action/:entity_id route":function(e){e.module==="products"&&this.setProduct(e.entity_id,e.action)},".addProduct click":function(e){this.viewModel.toEntity("0")},".editProduct click":function(e){var t=e.parents(".product").data("product");this.viewModel.toEntity(t.attr("_id"))},setProduct:function(e){this.viewModel.attr({id:Date.now(),viewState:"edit"});var i=this.element.find(".setProductWrap"),s=t.find(this.viewModel.products,function(t){return t.attr("_id")===e});new n(i,{product:s?s:new r})},".removeProduct click":function(e){var t=e.parents(".product").data("product");console.log(t),confirm('Вы действительно хотите удалить продукт: "'+t.attr("name")+'"?')&&t.destroy().always(function(e,t,n){i.attr("notification",{status:t,msg:e.name+". "+n.responseJSON.message})})},"{ProductsModel} updated":function(){this.viewModel.reOrderProducts()},"{ProductsModel} created":function(e,t,n){var r=this;products=r.viewModel.attr("products"),products.push(n),this.viewModel.reOrderProducts()}})});