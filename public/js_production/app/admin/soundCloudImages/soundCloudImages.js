define(["canjs","underscore","app/soundCloudImages/soundCloudImage","app/soundCloudImages/soundCloudImagesModel","soundcloud/sdk","css!app/soundCloudImages/css/soundCloudImages"],function(e,t,n,r){var i=e.Map.extend({uploaded:function(e,t){this.attr("image")||this.attr("image",{});var n=this.attr("image");n.attr(e,t)},removeUploaded:function(e){var t=this.attr("image");t.attr(e,undefined)}}),s=e.Map.extend({define:{viewState:{value:"list"}},reOrder:function(e,t){t=t||"position";var n=this.attr(e);n.sort(function(e,n){return e[t]>n[t]?1:e[t]<n[t]?-1:0})},toList:function(){e.route.attr({module:"soundCloudImages",action:undefined,entity_id:undefined}),this.attr("viewState","list")},toEntity:function(t){e.route.attr({entity_id:t.toString(),action:"set",module:"soundCloudImages"})},mergeData:function(e,n){return t.map(n,function(n){var i=t.find(e,function(e){return e.attr("playlistId")===n.attr("id")});return n.attr("image",i?i:new r),n})}});return e.Control.extend({defaults:{viewpath:"app/soundCloudImages/views/",soundCloudImagesModel:r,userPlaylistsLink:"/users/107070408/playlists",clientId:"36d9ee3197b18f8c51dbc9a24ef5cc70"}},{init:function(){var n=this,o=e.route.attr(),u=new s,a=e.Deferred(),f=new e.List(a);n.playlists=null,n.playlistDef=e.Deferred(),n.initSoundCloud(),u.attr({soundCloudImages:f}),e.when(r.findAll({}),n.playlistDef).then(function(e,n){n=t.map(n,function(e){return new i(e)}),a.resolve(u.mergeData(e,n))}),o.entity_id&&o.action&&(u.attr("viewState","edit"),e.when(u.attr("soundCloudImages")).then(function(){n.setSoundCloudImage(o.entity_id,o.action)})),n.element.html(e.view(n.options.viewpath+"index.stache",u)),this.viewModel=u},initSoundCloud:function(){var e=this;SC.initialize({client_id:e.options.clientId}),e.getPlaylists()},getPlaylists:function(){var e=this;SC.get(e.options.userPlaylistsLink,function(t){e.playlistDef.resolve(t)})},":module route":function(e){var t=this.viewModel,n=t.attr("viewState");e.module==="soundCloudImages"&&n!=="list"&&t.toList()},":module/:action/:entity_id route":function(e){e.module==="soundCloudImages"&&this.setSoundCloudImage(e.entity_id,e.action)},".editSoundCloudImage click":function(e){var t=e.parents(".soundCloudImage").data("soundCloudImage");this.viewModel.toEntity(t.attr("id"))},setSoundCloudImage:function(e){this.viewModel.attr({id:Date.now(),viewState:"edit"});var r=this,i=r.element.find(".setSoundCloudImageWrap"),s=t.find(r.viewModel.attr("soundCloudImages"),function(t){return t&&t.attr("id")==e});new n(i,{soundCloudImage:s})}})});