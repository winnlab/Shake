define(["jquery","Class","three","core/appState","managers/SceneManager","managers/TextManager","TweenLite"],function(e,t,n,r,i,s,o){var u=new t({renderer:undefined,rendererWebGL:undefined,rendererCanvas:undefined,antialias:!0,camera:undefined,scene:undefined,bgColor:"transperent",forceCanvas:!1,clearAlpha:1,alpha:!1,performanceScale:1,warmupCounter:5,initialize:function(e){this.options=e,u.instance=this,this.parent(e),this.camera=i.instance.camera,this.scene=i.instance.scene,this._canvasContext=null,this.warmupCounter=25,this.rendererCanvas=new n.CanvasRenderer({alpha:this.clearAlpha,clearColor:this.bgColor}),this.renderer=this.rendererCanvas,this._canvasContext=this.rendererCanvas.domElement.getContext("2d");var t=document.getElementById(e.selector);t.appendChild(this.renderer.domElement),window.addEventListener("resize",this.onWindowResize.bind(this),!1),this.hasRenderedOnce=!1,this.initText(e)},onWindowResize:function(){var t=r.attr("scene.width"),n=r.attr("scene.height"),i=~~(t*this.performanceScale),s=~~(n*this.performanceScale);this.renderer.setSize(i,s),e(this.renderer.domElement).css("width",t+"px").css("height",n+"px"),this.camera.aspect=r.attr("scene.aspectRatio"),this.camera.updateProjectionMatrix(),this.camera.far=r.attr("scene.distanceFar"),this.resizeText(t,n)},render:function(){if(this.warmupCounter>0){this.warmupCounter--,this.renderer.clear();return}this._canvasContext&&(this._canvasContext.clearRect(0,0,r.attr("scene.width"),r.attr("scene.height")),this.renderer.clear()),this.renderer.render(this.scene,this.camera),this.renderText(),this.hasRenderedOnce||(this.hasRenderedOnce=!0,this.animateInText())},initText:function(t){this.forceTextAntialiasing=!0,this.renderer.devicePixelRatio>1&&(this.forceTextAntialiasing=!1);var n=!this.rendererWebGL;this.textManager=new s(t.title,{fontSize:t.fontSize||r.fontSize()*5,snap:.999,text:t.title,align:t.align,letterSpacing:t.letterSpacing,spaceWidth:t.spaceWidth,lineOffset:t.lineOffset,mouseRadius:t.mouseRadius},o,null,n),this.textManager.style=0;var i=r.attr("scene.width"),u=r.attr("scene.height"),a=~~(i*this.performanceScale),f=~~(u*this.performanceScale);this.resizeText(i,u),e(window).on("mousemove.textfx",function(t){var n=1;if(this.forceTextAntialiasing||this._canvasContext)n=this.renderer.devicePixelRatio*this.performanceScale;var r=e(this.renderer.domElement).offset();this.textManager.onTouchMove(t.pageX*n-r.left,t.pageY*n-r.top)}.bind(this)),this.textManager.color.a=0},setTextAlpha:function(e){this.textManager.color.a=e},animateInText:function(){this.textManager.animateIn({onStart:this.setTextAlpha.bind(this,1),delay:0,delayIncrement:.2,duration:.8,yOff:30,ease:Expo.easeOut},{ease:Linear.easeNone,duration:.3,delay:0})},destroyText:function(){e(window).off("mousemove.textfx")},resizeText:function(e,t){if(!this.textManager)return;if(this.forceTextAntialiasing||this._canvasContext)e*=this.renderer.devicePixelRatio*this.performanceScale,t*=this.renderer.devicePixelRatio*this.performanceScale;var n=1024,r=300,i=e/n;i=Math.max(.75,Math.min(2.2,i)),this._canvasContext&&(i*=this.performanceScale);var s=this.textManager;s.resize(e,t);var o=(t-s.height*i)/2;s.scale=i,this.options.align=="center"?s.setPosition((e-s.width*i)/2,o):this.options.align=="left"&&s.setPosition(0,o),s.updateCamera()},renderText:function(){this.textManager.update(.3),this._canvasContext.fillStyle="black",this._canvasContext.strokeStyle="black",this._canvasContext.globalCompositeOperation="source-over",this.textManager.renderCanvas(this._canvasContext),this._canvasContext.fillStyle="white",this._canvasContext.strokeStyle="white"}});return u});