/*!
 * CanJS - 2.1.2
 * http://canjs.us/
 * Copyright (c) 2014 Bitovi
 * Mon, 16 Jun 2014 20:44:18 GMT
 * Licensed MIT
 * Includes: CanJS default build
 * Download from: http://canjs.us/
 */

define(["can/util/library","can/map/lazy/bubble","can/map","can/list","can/map/lazy/nested_reference"],function(e,t){var n=null,r=function(e){return n&&n[e._cid]&&n[e._cid].instance};return e.LazyMap=e.Map.extend({_bubble:t},{setup:function(t){this.constructor.Map=this.constructor,this.constructor.List=e.LazyList,this._data=e.extend(e.extend(!0,{},this.constructor.defaults||{}),t),e.cid(this,".lazyMap"),this._init=1,this._setupComputes();var n=t&&e.Map.helpers.addToMap(t,this);this._nestedReference=new e.NestedReference(this._data),n&&n(),e.each(this._data,e.proxy(function(e,t){this.___set(t,e)},this)),this.bind("change",e.proxy(this._changes,this)),delete this._init},_addChild:function(e,n,r){var i=this;this._nestedReference.removeChildren(e,function(r,s){t.remove(i,r);if(n){var o=s.replace(e+".","");if(e===o)r._nestedReference.each(function(e,r){n._nestedReference.make(r()),i._bindings&&t.add(this,n,r())});else{var u=n._nestedReference.make(o);i._bindings&&t.add(r,n,u())}}}),r&&r();if(n){var s=this._nestedReference.make(e);this._bindings&&t.add(this,n,s())}return n},removeAttr:function(t){var n=this._goto(t);return n.parts.length?n.value.removeAttr(n.parts.join(".")):(e.isArray(n.parent)?(n.parent.splice(n.prop,1),this._triggerChange(t,"remove",undefined,[this.__type(n.value,n.prop)])):n.parent[n.prop]&&(delete n.parent[n.prop],e.batch.trigger(this,n.path.length?n.path.join(".")+".__keys":"__keys"),this._triggerChange(t,"remove",undefined,this.__type(n.value,n.prop))),this._nestedReference.removeChildren(),n.value)},__type:function(t,n){if(!(t instanceof e.LazyMap)&&e.Map.helpers.canMakeObserve(t)){var i=r(t);if(i)return i;if(e.isArray(t)){var s=e.LazyList;return new s(t)}var o=this.constructor.Map||e.LazyMap;return new o(t)}return t},_goto:function(t,n){var r=e.Map.helpers.attrParts(t,n).slice(0),i,s=[],o,u=this instanceof e.List?this[r.shift()]:this.__get();while(u&&!e.Map.helpers.isObservable(u)&&r.length)o!==undefined&&s.push(o),i=u,u=u[o=r.shift()];return{parts:r,prop:o,value:u,parent:i,path:s}},_get:function(t){var n=this._goto(t);if(e.Map.helpers.isObservable(n.value))return n.parts.length?n.value._get(n.parts):n.value;if(n.value&&e.Map.helpers.canMakeObserve(n.value)){var r=this.__type(n.value,n.prop);return this._addChild(t,r,function(){n.parent[n.prop]=r}),r}return n.value!==undefined?n.value:this.__get(t)},_set:function(t,n,r){var i=this._goto(t,r);if(e.Map.helpers.isObservable(i.value)&&i.parts.length)return i.value._set(i.parts,n);if(!!i.parts.length)throw"can.LazyMap: object does not exist";this.__set(t,n,i.value,i)},__set:function(t,n,r,i,s){s=s||!0;if(n!==r){var o=i.parent.hasOwnProperty(i.prop)?"set":"add";if(s&&e.Map.helpers.canMakeObserve(n)){n=this.__type(n,t);var u=this;this._addChild(t,n,function(){u.___set(t,n,i)})}else this.___set(t,n,i);o==="add"&&e.batch.trigger(this,i.path.length?i.path.join(".")+".__keys":"__keys",undefined),this._triggerChange(t,o,n,r)}},___set:function(t,n,r){this[t]&&this[t].isComputed&&e.isFunction(this.constructor.prototype[t])?this[t](n):r?r.parent[r.prop]=n:this._data[t]=n,e.isFunction(this.constructor.prototype[t])||(this[t]=n)},_attrs:function(t,n){if(t===undefined)return e.Map.helpers.serialize(this,"attr",{});t=e.extend({},t);var r=this,i,s,o;e.batch.start(),this.each(function(i,u){o=t[u],s=r._goto(u,!0);if(o===undefined){n&&r.removeAttr(u);return}!e.Map.helpers.isObservable(i)&&e.Map.helpers.canMakeObserve(i)&&(i=r.attr(u)),r.__convert&&(o=r.__convert(u,o)),o instanceof e.Map?r.__set(u,o,i,s):e.Map.helpers.isObservable(i)&&e.Map.helpers.canMakeObserve(o)&&i.attr?i.attr(o,n):i!==o&&r.__set(u,o,i,s),delete t[u]});for(i in t)o=t[i],this._set(i,o,!0);return e.batch.stop(),this}}),e.LazyList=e.List.extend({Map:e.LazyMap},{setup:function(){e.List.prototype.setup.apply(this,arguments),this._nestedReference=new e.NestedReference(this)}}),e.LazyMap});