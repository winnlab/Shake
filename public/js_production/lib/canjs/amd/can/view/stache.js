/*!
 * CanJS - 2.1.2
 * http://canjs.us/
 * Copyright (c) 2014 Bitovi
 * Mon, 16 Jun 2014 20:44:18 GMT
 * Licensed MIT
 * Includes: CanJS default build
 * Download from: http://canjs.us/
 */

define(["can/util/library","can/view/parser","can/view/target","can/view/stache/html_section","can/view/stache/text_section","can/view/stache/mustache_core","can/view/stache/mustache_helpers","can/view/callbacks"],function(e,t,n,r,i,s,o,u){function a(n){n=s.cleanLineEndings(n);var o=new r,a={node:null,attr:null,sectionElementStack:[],text:!1},f=function(e,t,n){if(t===">")e.add(s.makeLiveBindingPartialRenderer(n,a));else if(t==="/")e.endSection(),e instanceof r&&a.sectionElementStack.pop();else if(t==="else")e.inverse();else{var i=e instanceof r?s.makeLiveBindingBranchRenderer:s.makeStringBranchRenderer;t==="{"||t==="&"?e.add(i(null,n,l())):t==="#"||t==="^"?(e.startSection(i(t,n,l())),e instanceof r&&a.sectionElementStack.push("section")):e.add(i(null,n,l({text:!0})))}},l=function(t){var n={tag:a.node&&a.node.tag,attr:a.attr&&a.attr.name,directlyNested:a.sectionElementStack[a.sectionElementStack.length-1]==="section"};return t?e.simpleExtend(n,t):n},c=function(e,t){e.attributes||(e.attributes=[]),e.attributes.push(t)};return t(n,{start:function(e,t){a.node={tag:e,children:[]}},end:function(e,t){var n=u.tag(e);t?(o.add(a.node),n&&c(a.node,function(t,n){u.tagHandler(this,e,{scope:t,options:n,subtemplate:null,templateType:"stache"})})):(o.push(a.node),a.sectionElementStack.push("element"),n&&o.startSubSection()),a.node=null},close:function(e){var t=u.tag(e),n;t&&(n=o.endSubSectionAndReturnRenderer());var r=o.pop();t&&c(r,function(t,r){u.tagHandler(this,e,{scope:t,options:r,subtemplate:n,templateType:"stache"})}),a.sectionElementStack.pop()},attrStart:function(e){a.node.section?a.node.section.add(e+'="'):a.attr={name:e,value:""}},attrEnd:function(e){if(a.node.section)a.node.section.add('" ');else{a.node.attrs||(a.node.attrs={}),a.node.attrs[a.attr.name]=a.attr.section?a.attr.section.compile(l()):a.attr.value;var t=u.attr(e);t&&(a.node.attributes||(a.node.attributes=[]),a.node.attributes.push(function(n,r){t(this,{attributeName:e,scope:n,options:r})})),a.attr=null}},attrValue:function(e){var t=a.node.section||a.attr.section;t?t.add(e):a.attr.value+=e},chars:function(e){o.add(e)},special:function(e){var t=s.splitModeFromExpression(e,a),n=t.mode,r=t.expression;if(r==="else"){(a.attr&&a.attr.section?a.attr.section:o).inverse();return}if(n==="!")return;if(a.node&&a.node.section)f(a.node.section,n,r),a.node.section.subSectionDepth()===0&&(a.node.attributes.push(a.node.section.compile(l())),delete a.node.section);else if(a.attr)a.attr.section||(a.attr.section=new i,a.attr.value&&a.attr.section.add(a.attr.value)),f(a.attr.section,n,r);else if(a.node){a.node.attributes||(a.node.attributes=[]);if(!n)a.node.attributes.push(s.makeLiveBindingBranchRenderer(null,r,l()));else{if(n!=="#"&&n!=="^")throw n+" is currently not supported within a tag.";a.node.section||(a.node.section=new i),f(a.node.section,n,r)}}else f(o,n,r)},comment:function(e){o.add({comment:e})},done:function(){}}),o.compile()}t=t||e.view.parser,u=u||e.view.callbacks;var f={"\n":"\\n","\r":"\\r","\u2028":"\\u2028","\u2029":"\\u2029"},l=function(e){return(""+e).replace(/["'\\\n\r\u2028\u2029]/g,function(e){return"'\"\\".indexOf(e)>=0?"\\"+e:f[e]})};return e.view.register({suffix:"stache",contentType:"x-stache-template",fragRenderer:function(e,t){return a(t)},script:function(e,t){return'can.stache("'+l(t)+'")'}}),e.view.ext=".stache",e.extend(e.stache,o),e.extend(a,o),e.stache.safeString=a.safeString=function(e){return{toString:function(){return e}}},a});