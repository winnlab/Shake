/*!
 * CanJS - 2.1.2
 * http://canjs.us/
 * Copyright (c) 2014 Bitovi
 * Mon, 16 Jun 2014 20:44:30 GMT
 * Licensed MIT
 * Includes: can/map/lazy
 * Download from: http://canjs.com
 */

(function(e){var t=function(e){var t=e.bubble;return e.extend({},t,{childrenOf:function(e,n){e._nestedReference?e._nestedReference.each(function(r,i){r&&r.bind&&t.toParent(r,e,i(),n)}):t._each.apply(this,arguments)}})}(window.can,e),n=function(t){var n=function(e,t,n){var r=t.split("."),i=e,s;while(s=r.shift())i=i[s],n&&n(i,s);return i},r=function(e){this.array=e};r.prototype.toString=function(){return""+t.inArray(this.item,this.array)};var i=function(e){this.root=e,this.references=[]};i.ArrIndex=r,t.extend(i.prototype,{make:function(i){var s=[],o;if(t.isArray(this.root)||this.root instanceof t.LazyList)o=new r(this.root);n(this.root,i,function(n,i){o?(o.item=n,s.push(o),o=e):(s.push(i),t.isArray(n)&&(o=new r(n)))});var u=function(){return s.join(".")};return this.references.push(u),u},removeChildren:function(e,t){var n=0;while(n<this.references.length){var r=this.references[n]();r.indexOf(e)===0?(t(this.get(r),r),this.references.splice(n,1)):n++}},get:function(e){return n(this.root,e)},each:function(e){var n=this;t.each(this.references,function(t){var r=t();e(n.get(r),t,r)})}}),t.NestedReference=i}(window.can),r=function(t,n){var r=null,i=function(e){return r&&r[e._cid]&&r[e._cid].instance};return t.LazyMap=t.Map.extend({_bubble:n},{setup:function(e){this.constructor.Map=this.constructor,this.constructor.List=t.LazyList,this._data=t.extend(t.extend(!0,{},this.constructor.defaults||{}),e),t.cid(this,".lazyMap"),this._init=1,this._setupComputes();var n=e&&t.Map.helpers.addToMap(e,this);this._nestedReference=new t.NestedReference(this._data),n&&n(),t.each(this._data,t.proxy(function(e,t){this.___set(t,e)},this)),this.bind("change",t.proxy(this._changes,this)),delete this._init},_addChild:function(e,t,r){var i=this;this._nestedReference.removeChildren(e,function(r,s){n.remove(i,r);if(t){var o=s.replace(e+".","");if(e===o)r._nestedReference.each(function(e,r){t._nestedReference.make(r()),i._bindings&&n.add(this,t,r())});else{var u=t._nestedReference.make(o);i._bindings&&n.add(r,t,u())}}}),r&&r();if(t){var s=this._nestedReference.make(e);this._bindings&&n.add(this,t,s())}return t},removeAttr:function(n){var r=this._goto(n);return r.parts.length?r.value.removeAttr(r.parts.join(".")):(t.isArray(r.parent)?(r.parent.splice(r.prop,1),this._triggerChange(n,"remove",e,[this.__type(r.value,r.prop)])):r.parent[r.prop]&&(delete r.parent[r.prop],t.batch.trigger(this,r.path.length?r.path.join(".")+".__keys":"__keys"),this._triggerChange(n,"remove",e,this.__type(r.value,r.prop))),this._nestedReference.removeChildren(),r.value)},__type:function(e,n){if(!(e instanceof t.LazyMap)&&t.Map.helpers.canMakeObserve(e)){var r=i(e);if(r)return r;if(t.isArray(e)){var s=t.LazyList;return new s(e)}var o=this.constructor.Map||t.LazyMap;return new o(e)}return e},_goto:function(n,r){var i=t.Map.helpers.attrParts(n,r).slice(0),s,o=[],u,a=this instanceof t.List?this[i.shift()]:this.__get();while(a&&!t.Map.helpers.isObservable(a)&&i.length)u!==e&&o.push(u),s=a,a=a[u=i.shift()];return{parts:i,prop:u,value:a,parent:s,path:o}},_get:function(n){var r=this._goto(n);if(t.Map.helpers.isObservable(r.value))return r.parts.length?r.value._get(r.parts):r.value;if(r.value&&t.Map.helpers.canMakeObserve(r.value)){var i=this.__type(r.value,r.prop);return this._addChild(n,i,function(){r.parent[r.prop]=i}),i}return r.value!==e?r.value:this.__get(n)},_set:function(e,n,r){var i=this._goto(e,r);if(t.Map.helpers.isObservable(i.value)&&i.parts.length)return i.value._set(i.parts,n);if(!!i.parts.length)throw"can.LazyMap: object does not exist";this.__set(e,n,i.value,i)},__set:function(n,r,i,s,o){o=o||!0;if(r!==i){var u=s.parent.hasOwnProperty(s.prop)?"set":"add";if(o&&t.Map.helpers.canMakeObserve(r)){r=this.__type(r,n);var a=this;this._addChild(n,r,function(){a.___set(n,r,s)})}else this.___set(n,r,s);u==="add"&&t.batch.trigger(this,s.path.length?s.path.join(".")+".__keys":"__keys",e),this._triggerChange(n,u,r,i)}},___set:function(e,n,r){this[e]&&this[e].isComputed&&t.isFunction(this.constructor.prototype[e])?this[e](n):r?r.parent[r.prop]=n:this._data[e]=n,t.isFunction(this.constructor.prototype[e])||(this[e]=n)},_attrs:function(n,r){if(n===e)return t.Map.helpers.serialize(this,"attr",{});n=t.extend({},n);var i=this,s,o,u;t.batch.start(),this.each(function(s,a){u=n[a],o=i._goto(a,!0);if(u===e){r&&i.removeAttr(a);return}!t.Map.helpers.isObservable(s)&&t.Map.helpers.canMakeObserve(s)&&(s=i.attr(a)),i.__convert&&(u=i.__convert(a,u)),u instanceof t.Map?i.__set(a,u,s,o):t.Map.helpers.isObservable(s)&&t.Map.helpers.canMakeObserve(u)&&s.attr?s.attr(u,r):s!==u&&i.__set(a,u,s,o),delete n[a]});for(s in n)u=n[s],this._set(s,u,!0);return t.batch.stop(),this}}),t.LazyList=t.List.extend({Map:t.LazyMap},{setup:function(){t.List.prototype.setup.apply(this,arguments),this._nestedReference=new t.NestedReference(this)}}),t.LazyMap}(window.can,t,e,e,n)})();